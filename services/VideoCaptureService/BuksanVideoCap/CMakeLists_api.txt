cmake_minimum_required(VERSION 3.16)
project(BuksanSpyNVR LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)

find_package(OpenCV REQUIRED core videoio)
find_package(Threads REQUIRED)
find_package(Crow CONFIG QUIET)
find_package(nlohmann_json CONFIG REQUIRED)

if(NOT TARGET Crow::Crow)
  find_path(CROW_INCLUDE_DIR crow.h)
  if(NOT CROW_INCLUDE_DIR)
    message(FATAL_ERROR
      "Crow не найден. Установите системный пакет Crow или задайте Crow_DIR/CMAKE_PREFIX_PATH.")
  endif()

  add_library(Crow INTERFACE)
  target_include_directories(Crow INTERFACE ${CROW_INCLUDE_DIR})
  add_library(Crow::Crow ALIAS Crow)
endif()

set(API_SRC
    main_api.cpp
    api/HttpServer.cpp
    core/CameraManager.cpp
    src/ConfigLoader.cpp
    src/StorageManager.cpp
    src/Analytics.cpp
    src/Recorder.cpp
    src/CameraSession.cpp
)

add_executable(BuksanSpyNVR_api ${API_SRC})

target_include_directories(BuksanSpyNVR_api PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${OpenCV_INCLUDE_DIRS}
)

target_link_libraries(BuksanSpyNVR_api PRIVATE
    ${OpenCV_LIBS}
    Crow::Crow
    nlohmann_json::nlohmann_json
)

install(TARGETS BuksanSpyNVR_api RUNTIME DESTINATION bin)
